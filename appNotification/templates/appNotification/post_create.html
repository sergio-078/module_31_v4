{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}–°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è{% endblock %}

{% block extra_css %}
<style>
    .editor-help {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .editor-help h5 {
        color: #1565c0;
        margin-bottom: 1rem;
    }

    #image-preview {
        margin-top: 1rem;
        text-align: center;
    }

    #image-preview img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .ck-editor-container {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 1rem;
    }

    .functionality-list {
        columns: 2;
        -webkit-columns: 2;
        -moz-columns: 2;
    }

    .functionality-list li {
        margin-bottom: 0.5rem;
        break-inside: avoid;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="text-center mb-0">
                    <i class="bi bi-plus-circle"></i> –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
                </h3>
            </div>
            <div class="card-body">
                <!-- –ü–æ–º–æ—â—å –ø–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä—É -->
                <div class="editor-help">
                    <h5><i class="bi bi-lightbulb"></i> –†–µ–¥–∞–∫—Ç–æ—Ä —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –º–µ–¥–∏–∞</h5>
                    <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –≤–∏–¥–µ–æ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞:</p>
                </div>

                <form method="post" enctype="multipart/form-data" id="post-form">
                    {% csrf_token %}

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.category|as_crispy_field }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.title|as_crispy_field }}
                            </div>
                        </div>
                    </div>

                    <!-- –ü–æ–ª–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å CKEditor -->
                    <div class="form-group mb-4">
                        <label class="form-label fw-bold">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è *</label>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä –Ω–∏–∂–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –≤–∏–¥–µ–æ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                        </div>

                        <div class="ck-editor-container">
                            <textarea name="content" id="content-editor" rows="10" cols="80">
                                {{ form.content.value|default:'' }}
                            </textarea>
                        </div>
                        <small class="form-text text-muted">
                            –ú–∏–Ω–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –≤—Å—Ç–∞–≤–∫–∞ –≤–∏–¥–µ–æ –∏ HTML-–∫–æ–Ω—Ç–µ–Ω—Ç–∞.
                        </small>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.image|as_crispy_field }}
                                <div id="image-preview" class="text-center"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.video|as_crispy_field }}
                                <small class="form-text text-muted">
                                    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: MP4, AVI, MOV, WMV, WebM (–º–∞–∫—Å. 100MB)
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="form-group mb-4">
                        <div class="form-check form-switch">
                            {{ form.notify_subscribers }}
                            <label class="form-check-label" for="{{ form.notify_subscribers.id_for_label }}">
                                {{ form.notify_subscribers.label }}
                            </label>
                        </div>
                        <small class="form-text text-muted">
                            {{ form.notify_subscribers.help_text }}
                        </small>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="submit" class="btn btn-primary btn-lg me-md-2">
                            <i class="bi bi-check-circle"></i> –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
                        </button>
                        <a href="{% url 'post_list' %}" class="btn btn-secondary btn-lg">
                            <i class="bi bi-x-circle"></i> –û—Ç–º–µ–Ω–∞
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ -->
        <div class="card mt-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="bi bi-book"></i> –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>üì∑ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:</h6>
                        <ol class="small">
                            <li>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É <strong>"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"</strong> –≤ –ø–∞–Ω–µ–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤</li>
                            <li>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∫–ª–∞–¥–∫—É <strong>"–ó–∞–≥—Ä—É–∑–∏—Ç—å"</strong></li>
                            <li>–ù–∞–∂–º–∏—Ç–µ <strong>"–û–±–∑–æ—Ä"</strong> –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</li>
                            <li>–ù–∞–∂–º–∏—Ç–µ <strong>"–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä"</strong></li>
                            <li>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—Å—Ç–∞–≤–∏—Ç—Å—è –≤ —Ç–µ–∫—Å—Ç</li>
                        </ol>
                    </div>
                    <div class="col-md-6">
                        <h6>üé¨ –í—Å—Ç–∞–≤–∫–∞ –º–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–Ω—Ç–∞:</h6>
                        <ul class="small">
                            <li><strong>YouTube –≤–∏–¥–µ–æ:</strong> –í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –≤ —Ç–µ–∫—Å—Ç</li>
                            <li><strong>–°—Å—ã–ª–∫–∏:</strong> –í—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç ‚Üí –Ω–∞–∂–º–∏—Ç–µ üîó</li>
                            <li><strong>–¢–∞–±–ª–∏—Ü—ã:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–¢–∞–±–ª–∏—Ü–∞"</li>
                            <li><strong>–°–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã:</strong> –ö–Ω–æ–ø–∫–∞ "–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã"</li>
                        </ul>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6>üé® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞:</h6>
                        <ul class="functionality-list">
                            <li><strong>B</strong> - –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç</li>
                            <li><strong>I</strong> - –ö—É—Ä—Å–∏–≤</li>
                            <li><strong>U</strong> - –ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ</li>
                            <li><strong>S</strong> - –ó–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π</li>
                            <li>–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞</li>
                            <li>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</li>
                            <li>–¶–≤–µ—Ç —Ñ–æ–Ω–∞</li>
                            <li>–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:</h6>
                        <ul class="functionality-list">
                            <li>–ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏</li>
                            <li>–ú–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏</li>
                            <li>–¶–∏—Ç–∞—Ç—ã</li>
                            <li>–û—Ç—Å—Ç—É–ø—ã</li>
                            <li>–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏</li>
                            <li>–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞</li>
                            <li>–û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞</li>
                            <li>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è CKEditor
function initCKEditor() {
    CKEDITOR.replace('content-editor', {
        // –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        language: 'ru',
        height: 400,
        width: '100%',

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
        filebrowserUploadUrl: '/ckeditor/upload/',
        filebrowserUploadMethod: 'form',

        // –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        toolbar: [
            { name: 'document', items: ['Source', '-', 'Preview', 'Print'] },
            { name: 'clipboard', items: ['Cut', 'Copy', 'Paste', 'PasteText', 'PasteFromWord', '-', 'Undo', 'Redo'] },
            { name: 'editing', items: ['Find', 'Replace', '-', 'SelectAll'] },
            { name: 'basicstyles', items: ['Bold', 'Italic', 'Underline', 'Strike', 'Subscript', 'Superscript', '-', 'RemoveFormat'] },
            { name: 'paragraph', items: ['NumberedList', 'BulletedList', '-', 'Outdent', 'Indent', '-', 'Blockquote', 'CreateDiv', '-', 'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock'] },
            { name: 'links', items: ['Link', 'Unlink', 'Anchor'] },
            { name: 'insert', items: ['Image', 'Flash', 'Table', 'HorizontalRule', 'Smiley', 'SpecialChar'] },
            { name: 'styles', items: ['Styles', 'Format', 'Font', 'FontSize'] },
            { name: 'colors', items: ['TextColor', 'BGColor'] },
            { name: 'tools', items: ['Maximize', 'ShowBlocks'] }
        ],

        // –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
        allowedContent: true,
        extraAllowedContent: '*(*);*{*}',
        disallowedContent: 'script; *[on*]',

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        removePlugins: 'resize,elementspath',
        autoParagraph: false,
        fillEmptyBlocks: false,
        tabSpaces: 4
    });
}

// –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        const preview = document.getElementById('image-preview');

        preview.innerHTML = '';

        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.alt = '–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';
            img.className = 'img-thumbnail';
            img.style.maxHeight = '200px';
            preview.appendChild(img);
        };

        reader.readAsDataURL(input.files[0]);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
document.addEventListener('DOMContentLoaded', function() {
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è CKEditor...');

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º CKEditor
    if (typeof CKEDITOR !== 'undefined') {
        setTimeout(initCKEditor, 100);
    } else {
        console.error('CKEditor –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        // Fallback: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
        const editor = document.getElementById('content-editor');
        if (editor) {
            editor.style.display = 'block';
            editor.style.visibility = 'visible';
            editor.classList.add('form-control');
        }
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    const imageInput = document.querySelector('#id_image');
    if (imageInput) {
        imageInput.addEventListener('change', function() {
            previewImage(this);
        });
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
    const form = document.getElementById('post-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (typeof CKEDITOR !== 'undefined' && CKEDITOR.instances['content-editor']) {
                const content = CKEDITOR.instances['content-editor'].getData();
                const plainText = content.replace(/<[^>]*>/g, '').trim();

                if (plainText.length < 20) {
                    e.preventDefault();
                    alert('–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤ —Ç–µ–∫—Å—Ç–∞');
                    return false;
                }

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—á–∏—â–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'content';
                hiddenInput.value = content;
                form.appendChild(hiddenInput);
            }
        });
    }
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
function checkEditorFunctions() {
    if (typeof CKEDITOR !== 'undefined' && CKEDITOR.instances['content-editor']) {
        const editor = CKEDITOR.instances['content-editor'];
        console.log('–†–µ–¥–∞–∫—Ç–æ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:', Object.keys(editor.commands));
    }
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
setTimeout(checkEditorFunctions, 3000);
</script>
{% endblock %}