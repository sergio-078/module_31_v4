{% extends 'base.html' %}

{% block title %}Личный кабинет{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h5>Меню</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    <a href="#posts" class="list-group-item list-group-item-action">Мои объявления</a>
                    <a href="#responses" class="list-group-item list-group-item-action">Мои отклики</a>
                    <a href="#incoming" class="list-group-item list-group-item-action">Входящие отклики</a>
                    <a href="#subscriptions" class="list-group-item list-group-item-action">Подписки</a>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <!-- Мои объявления -->
        <div class="card mb-4" id="posts">
            <div class="card-header">
                <h5>Мои объявления ({{ user_posts.count }})</h5>
            </div>
            <div class="card-body">
                {% for post in user_posts %}
                    <div class="card mb-2">
                        <div class="card-body">
                            <h6 class="card-title">{{ post.title }}</h6>
                            <p class="card-text">{{ post.content|striptags|truncatewords:20 }}</p>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">
                                    {{ post.created_at|date:"d.m.Y H:i" }} |
                                    <span class="badge bg-secondary">{{ post.get_category_display }}</span>
                                </small>
                                <div>
                                    <a href="{% url 'post_edit' post.id %}" class="btn btn-sm btn-outline-primary">Редактировать</a>
                                    <a href="{% url 'post_delete' post.id %}" class="btn btn-sm btn-outline-danger">Удалить</a>
                                </div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <p class="text-muted">У вас пока нет объявлений</p>
                {% endfor %}
            </div>
        </div>

        <!-- Входящие отклики -->
        <div class="card mb-4" id="incoming">
            <div class="card-header">
                <h5>Входящие отклики ({{ responses_to_posts.count }})</h5>
            </div>
            <div class="card-body">
                <form method="get" class="mb-3">
                    <div class="row">
                        <div class="col-md-5">
                            <select name="post_filter" class="form-select">
                                <option value="">Все объявления</option>
                                {% for post in user_posts %}
                                    <option value="{{ post.id }}" {% if post_filter == post.id|stringformat:"s" %}selected{% endif %}>
                                        {{ post.title }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-5">
                            <select name="status_filter" class="form-select">
                                <option value="">Все статусы</option>
                                <option value="accepted" {% if status_filter == 'accepted' %}selected{% endif %}>Принятые</option>
                                <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Ожидающие</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">Фильтровать</button>
                        </div>
                    </div>
                </form>

                {% for response in responses_to_posts %}
                    <div class="card mb-2 {% if response.is_accepted %}border-success{% elif response.is_rejected %}border-danger{% endif %}">
                        <div class="card-body">
                            <h6 class="card-title">
                                К объявлению: <a href="{% url 'post_detail' response.post.id %}">{{ response.post.title }}</a>
                            </h6>
                            <p class="card-text">{{ response.text }}</p>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">
                                    От: {{ response.author.email }} |
                                    {{ response.created_at|date:"d.m.Y H:i" }} |
                                    {% if response.is_accepted %}
                                        <span class="badge bg-success">Принят</span>
                                    {% elif response.is_rejected %}
                                        <span class="badge bg-danger">Отклонен</span>
                                    {% else %}
                                        <span class="badge bg-warning">Ожидает</span>
                                    {% endif %}
                                </small>
                                <div>
                                    {% if not response.is_accepted and not response.is_rejected %}
                                        <form action="{% url 'accept_response' response.id %}" method="post" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-success">Принять</button>
                                        </form>
                                        <form action="{% url 'reject_response' response.id %}" method="post" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-danger">Отклонить</button>
                                        </form>
                                    {% endif %}
                                    <a href="{% url 'response_detail' response.id %}" class="btn btn-sm btn-outline-primary">Подробнее</a>
                                </div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <p class="text-muted">Нет входящих откликов</p>
                {% endfor %}
            </div>
        </div>

        <!-- Подписки -->
        <div class="card mb-4" id="subscriptions">
            <div class="card-header">
                <h5>Мои подписки</h5>
            </div>
            <div class="card-body">
                <form method="post" class="mb-3">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-check-label">
                            <input type="checkbox" name="news_subscribe" class="form-check-input" {% if news_subscribed %}checked{% endif %}>
                            Подписаться на новости
                        </label>
                        <button type="submit" class="btn btn-sm btn-outline-primary ms-2">Сохранить</button>
                    </div>
                </form>

                <h6>Подписки на категории:</h6>
                <div class="row">
                    {% for item in categories_with_status %}
                        <div class="col-md-6 mb-2">
                            <form method="post" action="{% url 'category_subscribe' item.category.id %}">
                                {% csrf_token %}
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" {% if item.is_subscribed %}checked{% endif %}
                                           onchange="this.form.submit()">
                                    <label class="form-check-label">{{ item.category.name }}</label>
                                </div>
                            </form>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}