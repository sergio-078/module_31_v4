{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è{% endblock %}

{% block extra_css %}
<style>
    .editor-help {
        background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .editor-help h5 {
        color: #e65100;
        margin-bottom: 1rem;
    }

    #image-preview {
        margin-top: 1rem;
        text-align: center;
    }

    #image-preview img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .ck-editor-container {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 1rem;
    }

    .current-media {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
    }

    .current-media img {
        max-width: 100%;
        max-height: 150px;
        border-radius: 6px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h3 class="text-center mb-0">
                    <i class="bi bi-pencil"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
                </h3>
            </div>
            <div class="card-body">
                <!-- –ü–æ–º–æ—â—å –ø–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä—É -->
                <div class="editor-help">
                    <h5><i class="bi bi-lightbulb"></i> –†–µ–¥–∞–∫—Ç–æ—Ä —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –º–µ–¥–∏–∞</h5>
                    <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞, –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –≤–∏–¥–µ–æ.</p>
                </div>

                <form method="post" enctype="multipart/form-data" id="post-form">
                    {% csrf_token %}

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.category|as_crispy_field }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.title|as_crispy_field }}
                            </div>
                        </div>
                    </div>

                    <!-- –ü–æ–ª–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å CKEditor -->
                    <div class="form-group mb-4">
                        <label class="form-label fw-bold">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è *</label>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞, –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –≤–∏–¥–µ–æ
                        </div>

                        <div class="ck-editor-container">
                            <textarea name="content" id="content-editor" rows="10" cols="80">
                                {{ form.content.value|default:object.content|safe }}
                            </textarea>
                        </div>
                        <small class="form-text text-muted">
                            –ú–∏–Ω–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –≤—Å—Ç–∞–≤–∫–∞ –≤–∏–¥–µ–æ –∏ HTML-–∫–æ–Ω—Ç–µ–Ω—Ç–∞.
                        </small>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.image|as_crispy_field }}
                                <div id="image-preview" class="text-center"></div>

                                <!-- –¢–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
                                {% if object.image %}
                                <div class="current-media mt-3">
                                    <h6>–¢–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</h6>
                                    <img src="{{ object.image.url }}" alt="–¢–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" class="img-thumbnail">
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" name="image-clear" id="image-clear">
                                        <label class="form-check-label" for="image-clear">
                                            –£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                                        </label>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.video|as_crispy_field }}
                                <small class="form-text text-muted">
                                    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: MP4, AVI, MOV, WMV, WebM (–º–∞–∫—Å. 100MB)
                                </small>

                                <!-- –¢–µ–∫—É—â–µ–µ –≤–∏–¥–µ–æ -->
                                {% if object.video %}
                                <div class="current-media mt-3">
                                    <h6>–¢–µ–∫—É—â–µ–µ –≤–∏–¥–µ–æ:</h6>
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-info me-2">
                                            <i class="bi bi-film"></i> {{ object.video.name|slice:"-20:" }}
                                        </span>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="video-clear" id="video-clear">
                                            <label class="form-check-label" for="video-clear">
                                                –£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –≤–∏–¥–µ–æ
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="form-group mb-4">
                        <div class="form-check form-switch">
                            {{ form.notify_subscribers }}
                            <label class="form-check-label" for="{{ form.notify_subscribers.id_for_label }}">
                                {{ form.notify_subscribers.label }}
                            </label>
                        </div>
                        <small class="form-text text-muted">
                            {{ form.notify_subscribers.help_text }}
                        </small>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="submit" class="btn btn-primary btn-lg me-md-2">
                            <i class="bi bi-check-circle"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        </button>
                        <a href="{% url 'post_detail' object.id %}" class="btn btn-secondary btn-lg">
                            <i class="bi bi-x-circle"></i> –û—Ç–º–µ–Ω–∞
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ -->
        <div class="card mt-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="bi bi-book"></i> –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>üì∑ –ú–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–Ω—Ç:</h6>
                        <ul class="small">
                            <li><strong>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</strong> –ö–Ω–æ–ø–∫–∞ "Image" ‚Üí "–ó–∞–≥—Ä—É–∑–∏—Ç—å"</li>
                            <li><strong>–í–∏–¥–µ–æ:</strong> –í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É YouTube –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ú–µ–¥–∏–∞"</li>
                            <li><strong>–¢–∞–±–ª–∏—Ü—ã:</strong> –ö–Ω–æ–ø–∫–∞ "Table" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü</li>
                            <li><strong>–°—Å—ã–ª–∫–∏:</strong> –í—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç ‚Üí –∫–Ω–æ–ø–∫–∞ "Link"</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>üé® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:</h6>
                        <ul class="small">
                            <li><strong>B</strong> - –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç</li>
                            <li><strong>I</strong> - –ö—É—Ä—Å–∏–≤</li>
                            <li><strong>U</strong> - –ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ</li>
                            <li><strong>–¶–≤–µ—Ç–∞</strong> - –¢–µ–∫—Å—Ç –∏ —Ñ–æ–Ω</li>
                            <li><strong>–°–ø–∏—Å–∫–∏</strong> - –ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏ –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</li>
                            <li><strong>–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ</strong> - –ü–æ left/center/right</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è CKEditor
function initCKEditor() {
    CKEDITOR.replace('content-editor', {
        // –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        language: 'ru',
        height: 400,
        width: '100%',

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
        filebrowserUploadUrl: '/ckeditor/upload/',
        filebrowserUploadMethod: 'form',

        // –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        toolbar: [
            { name: 'document', items: ['Source', '-', 'Preview', 'Print'] },
            { name: 'clipboard', items: ['Cut', 'Copy', 'Paste', 'PasteText', 'PasteFromWord', '-', 'Undo', 'Redo'] },
            { name: 'editing', items: ['Find', 'Replace', '-', 'SelectAll'] },
            { name: 'basicstyles', items: ['Bold', 'Italic', 'Underline', 'Strike', 'Subscript', 'Superscript', '-', 'RemoveFormat'] },
            { name: 'paragraph', items: ['NumberedList', 'BulletedList', '-', 'Outdent', 'Indent', '-', 'Blockquote', 'CreateDiv', '-', 'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock'] },
            { name: 'links', items: ['Link', 'Unlink', 'Anchor'] },
            { name: 'insert', items: ['Image', 'Flash', 'Table', 'HorizontalRule', 'Smiley', 'SpecialChar'] },
            { name: 'styles', items: ['Styles', 'Format', 'Font', 'FontSize'] },
            { name: 'colors', items: ['TextColor', 'BGColor'] },
            { name: 'tools', items: ['Maximize', 'ShowBlocks'] }
        ],

        // –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
        allowedContent: true,
        extraAllowedContent: '*(*);*{*}',
        disallowedContent: 'script; *[on*]',

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        removePlugins: 'resize,elementspath',
        autoParagraph: false,
        fillEmptyBlocks: false,
        tabSpaces: 4
    });
}

// –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        const preview = document.getElementById('image-preview');

        preview.innerHTML = '';

        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.alt = '–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';
            img.className = 'img-thumbnail';
            img.style.maxHeight = '200px';
            preview.appendChild(img);
        };

        reader.readAsDataURL(input.files[0]);
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤
function setupMediaDeletion() {
    const imageClear = document.getElementById('image-clear');
    const videoClear = document.getElementById('video-clear');
    const imageInput = document.querySelector('#id_image');
    const videoInput = document.querySelector('#id_video');

    if (imageClear && imageInput) {
        imageClear.addEventListener('change', function() {
            if (this.checked) {
                imageInput.disabled = true;
            } else {
                imageInput.disabled = false;
            }
        });
    }

    if (videoClear && videoInput) {
        videoClear.addEventListener('change', function() {
            if (this.checked) {
                videoInput.disabled = true;
            } else {
                videoInput.disabled = false;
            }
        });
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
document.addEventListener('DOMContentLoaded', function() {
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è CKEditor –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...');

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º CKEditor
    if (typeof CKEDITOR !== 'undefined') {
        setTimeout(initCKEditor, 100);
    } else {
        console.error('CKEditor –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        // Fallback: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
        const editor = document.getElementById('content-editor');
        if (editor) {
            editor.style.display = 'block';
            editor.style.visibility = 'visible';
            editor.classList.add('form-control');
        }
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    const imageInput = document.querySelector('#id_image');
    if (imageInput) {
        imageInput.addEventListener('change', function() {
            previewImage(this);
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —É–¥–∞–ª–µ–Ω–∏—è –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const imageClear = document.getElementById('image-clear');
            if (imageClear) {
                imageClear.checked = false;
            }
        });
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è –º–µ–¥–∏–∞
    setupMediaDeletion();

    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
    const form = document.getElementById('post-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (typeof CKEDITOR !== 'undefined' && CKEDITOR.instances['content-editor']) {
                const content = CKEDITOR.instances['content-editor'].getData();
                const plainText = content.replace(/<[^>]*>/g, '').trim();

                if (plainText.length < 20) {
                    e.preventDefault();
                    alert('–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤ —Ç–µ–∫—Å—Ç–∞');
                    return false;
                }

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—á–∏—â–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'content';
                hiddenInput.value = content;
                form.appendChild(hiddenInput);
            }
        });
    }
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
function checkEditorFunctions() {
    if (typeof CKEDITOR !== 'undefined' && CKEDITOR.instances['content-editor']) {
        const editor = CKEDITOR.instances['content-editor'];
        console.log('–†–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω');
    }
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
setTimeout(checkEditorFunctions, 3000);
</script>
{% endblock %}